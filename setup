#!/usr/bin/env bash
set -eou pipefail

echo "ğŸ setting up folder for ty at /usr/"$USER""
sudo mkdir -p /usr/"$USER"
sudo cp ty /usr/"$USER"
sudo chmod +x /usr/"$USER"/ty
sudo cp parse-toml.py /usr/"$USER"

echo ğŸ installing requirements
echo + cat requirements.txt
echo "$(cat requirements.txt)"
printf "+ py -m pip -q -q -q install -r requirements.txt\n"
set +e
pip_text="$(py -m pip -q -q -q install -r requirements.txt)"
pip_status_code=$?
set -e
if [[ $pip_status_code -eq 1 ]]; then
  echo 'Error: cannot install ty requirements' >&2
  exit 1
fi

echo "ğŸ adding ty folder /usr/"$USER" to PATH in ~/.bashrc"
set +e
grep -q 'export PATH=\"/usr/\$USER:\$PATH\"' ~/.bashrc
grep_return=$?
set -e
if [[ $grep_return == 1 ]]; then
    echo "export PATH=\"/usr/\$USER:\$PATH\"" >> ~/.bashrc
fi

echo "ğŸ setting ENV variables for pip pyright in ~/.bashrc"
set +e
grep -q "PYRIGHT_PYTHON_FORCE_VERSION=\"latest\"" ~/.bashrc
grep_return=$?
set -e
if [[ $grep_return == 1 ]]; then
    echo "PYRIGHT_PYTHON_FORCE_VERSION=\"latest\"" >> ~/.bashrc
fi

set +H
printf "ğŸ success! restart terminal to use ty\n"
