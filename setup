#!/usr/bin/env bash
set -eou pipefail

echo "🐍 setting up folder for ty at /usr/"$USER""
set -x
sudo mkdir -p /usr/"$USER"
sudo cp ty /usr/"$USER"
sudo chmod +x /usr/"$USER"/ty

set +x
echo 🐍 installing requirements
echo + cat requirements.txt
echo "$(cat requirements.txt)"
printf "+ py -m pip -q -q -q install -r requirements.txt\n"
set +e
pip_text="$(py -m pip -q -q -q install -r requirements.txt)"
pip_status_code=$?
set -e
if [[ $pip_status_code -eq 1 ]]; then
  echo 'Error: cannot install ty requirements' >&2
  exit 1
fi

echo "🐍 adding ty folder /usr/"$USER" to PATH in ~/.bashrc"
set -x
set +e
grep -q 'export PATH=\"/usr/\$USER:\$PATH\"' ~/.bashrc
grep_return=$?
set -e
if [[ $grep_return == 1 ]]; then
    echo "export PATH=\"/usr/\$USER:\$PATH\"" >> ~/.bashrc
fi

set +x
echo "🐍 adding RY enviromental variable in ~/.bashrc"
set -x
set +e
grep -q 'export RY=\"py\"' ~/.bashrc
grep_return=$?
set -e
if [[ $grep_return == 1 ]]; then
    echo "export RY=\"py\"" >> ~/.bashrc
fi

set +xH
printf "🐍 success! restart terminal to use ty\n"
