#!/usr/bin/env bash
set -eou pipefail

echo "🐍 setting up folder for ty at /usr/"$USER""
set -x
sudo mkdir -p /usr/"$USER"
sudo cp ty /usr/"$USER"
sudo chmod +x /usr/"$USER"/ty
sudo cp parse-toml.py /usr/"$USER"

# set +x
# echo 🐍 installing requirements
# echo + cat requirements.txt
# echo "$(cat requirements.txt)"
# printf "+ py -m pip -q -q -q install -r requirements.txt\n"
# set +e
# pip_text="$(py -m pip -q -q -q install -r requirements.txt)"
# pip_status_code=$?
# set -e
# if [[ $pip_status_code -eq 1 ]]; then
#   echo 'Error: cannot install ty requirements' >&2
#   exit 1
# fi

export_to_bashrc_if_needed() {
    set -x
    set +e
    grep -q $1 ~/.bashrc
    grep_return=$?
    set -e
    if [[ $grep_return == 1 ]]; then
        echo $1 >> ~/.bashrc
    fi
}

echo "🐍 adding ty folder /usr/"$USER" to PATH in ~/.bashrc"
export_to_bashrc_if_needed "export PATH=\"/usr/\$USER:\$PATH\""
echo "🐍 setting ENV variables for pip pyright in ~/.bashrc"
export_to_bashrc_if_needed "PYRIGHT_PYTHON_FORCE_VERSION=\"latest\""

set +xH
printf "🐍 success! restart terminal to use ty\n"
